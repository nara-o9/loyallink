{% extends "admin/base_admin.html" %}

{% block content %}

<div class="mb-8">
  <h1 class="text-4xl font-bold mb-2 text-gray-900">Dashboard</h1>
  <p class="text-gray-500">Welcome to your loyalty program management center</p>
</div>

<!-- KPI Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

  <!-- Total Customers Card -->
  <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-1 duration-300 border border-gray-100">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-gray-500 text-sm font-medium mb-2">Total Customers</p>
        <h2 class="text-3xl font-bold text-gray-900">{{ total_customers }}</h2>
        <p class="text-gray-400 text-xs mt-2">Active members</p>
      </div>
      <div class="bg-indigo-100 p-3 rounded-xl">
        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.856-1.487M15 10a3 3 0 11-6 0 3 3 0 016 0zM4 20h16c.552 0 1-.448 1-1v-2a3 3 0 00-3-3H5a3 3 0 00-3 3v2c0 .552.448 1 1 1z"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Products Card -->
  <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-1 duration-300 border border-gray-100">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-gray-500 text-sm font-medium mb-2">Products</p>
        <h2 class="text-3xl font-bold text-gray-900">{{ total_products }}</h2>
        <p class="text-gray-400 text-xs mt-2">In catalog</p>
      </div>
      <div class="bg-emerald-100 p-3 rounded-xl">
        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m0 0l8 4m-8-4v10l8 4m0-10l8 4m-8-4v10l8 4M7 12l8 4m0 0l8-4"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Total Revenue Card -->
  <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-1 duration-300 border border-gray-100">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-gray-500 text-sm font-medium mb-2">Total Revenue</p>
        <h2 class="text-3xl font-bold text-gray-900">Rs {{ "%.0f"|format(total_revenue) }}</h2>
        <p class="text-gray-400 text-xs mt-2">All time</p>
      </div>
      <div class="bg-blue-100 p-3 rounded-xl">
        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Active Cards Card -->
  <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-1 duration-300 border border-gray-100">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-gray-500 text-sm font-medium mb-2">Active Cards</p>
        <h2 class="text-3xl font-bold text-gray-900">{{ active_cards }}</h2>
        <p class="text-gray-400 text-xs mt-2">Loyalty cards</p>
      </div>
      <div class="bg-purple-100 p-3 rounded-xl">
        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
        </svg>
      </div>
    </div>
  </div>

</div>

<!-- Additional Metrics Row -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

  <!-- Total Sales Card -->
  <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all border border-gray-100">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-gray-500 text-sm font-medium mb-2">Total Sales</p>
        <h2 class="text-2xl font-bold text-gray-900">{{ total_sales }}</h2>
      </div>
      <div class="text-3xl">üõí</div>
    </div>
  </div>

  <!-- Monthly Revenue Card -->
  <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all border border-gray-100">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-gray-500 text-sm font-medium mb-2">Monthly Revenue</p>
        <h2 class="text-2xl font-bold text-gray-900">Rs {{ "%.0f"|format(monthly_revenue) }}</h2>
      </div>
      <div class="text-3xl">üìà</div>
    </div>
  </div>

  <!-- Points Issued Card -->
  <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all border border-gray-100">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-gray-500 text-sm font-medium mb-2">Points Issued Today</p>
        <h2 class="text-2xl font-bold text-gray-900">{{ points_issued_today }}</h2>
      </div>
      <div class="text-3xl">‚≠ê</div>
    </div>
  </div>

</div>

<!-- Charts Section -->
<div class="mb-8">
  <h2 class="text-2xl font-bold text-gray-900 mb-6">Analytics</h2>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Sales Over Time Chart -->
    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Sales Over Time (7 Days)</h3>
      <canvas id="salesChart" height="300"></canvas>
    </div>

    <!-- Loyalty Tier Distribution Chart -->
    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Loyalty Tier Distribution</h3>
      <div style="display: flex; justify-content: center;">
        <canvas id="tierChart" height="300" style="max-width: 300px;"></canvas>
      </div>
    </div>

  </div>
</div>

<!-- Recent Sales Section -->
<div>
  <h2 class="text-2xl font-bold text-gray-900 mb-6">Recent Sales</h2>
  <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="bg-gray-50 border-b border-gray-200">
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Date</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Customer</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Items</th>
            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-700">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for sale in recent_sales %}
          <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
            <td class="px-6 py-4 text-sm text-gray-700">{{ sale.date.strftime('%b %d, %Y %H:%M') }}</td>
            <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ sale.user.username if sale.user else 'Unknown' }}</td>
            <td class="px-6 py-4 text-sm text-gray-600">{{ sale.items[:30] if sale.items else 'N/A' }}{% if sale.items and sale.items|length > 30 %}...{% endif %}</td>
            <td class="px-6 py-4 text-sm font-semibold text-indigo-600 text-right">Rs {{ "%.2f"|format(sale.amount) }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="px-6 py-8 text-center text-gray-500">No recent sales</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Sales Over Time - Line Chart
  const salesData = {{ sales_by_date | safe }};
  const salesCtx = document.getElementById('salesChart').getContext('2d');
  new Chart(salesCtx, {
    type: 'line',
    data: {
      labels: Object.keys(salesData),
      datasets: [{
        label: 'Sales (Rs)',
        data: Object.values(salesData),
        borderColor: '#4f46e5',
        backgroundColor: 'rgba(79, 70, 229, 0.08)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#4f46e5',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'Rs ' + value.toFixed(0);
            }
          }
        }
      }
    }
  });

  // Loyalty Tier Distribution - Pie Chart
  const tierCtx = document.getElementById('tierChart').getContext('2d');
  new Chart(tierCtx, {
    type: 'doughnut',
    data: {
      labels: ['Silver', 'Gold', 'Platinum'],
      datasets: [{
        data: [{{ silver_count }}, {{ gold_count }}, {{ platinum_count }}],
        backgroundColor: [
          'rgba(99, 102, 241, 0.8)',
          'rgba(34, 197, 94, 0.8)',
          'rgba(251, 191, 36, 0.8)'
        ],
        borderColor: [
          '#6366f1',
          '#22c55e',
          '#fbbf24'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            padding: 15,
            usePointStyle: true
          }
        }
      }
    }
  });
</script>

{% endblock %}


{% extends "admin/base_admin.html" %}

{% block content %}

<h2 style="margin-bottom: 2rem;">üõçÔ∏è Customer Orders</h2>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3>All Online Orders</h3>
        <p style="color: var(--text-muted); font-size: 0.9rem;">
            Total: {{ orders|length }} | 
            Revenue: <strong>Rs. {{ "%.2f"|format(orders|selectattr('payment_status', 'equalto', 'completed')|sum(attribute='total')) }}</strong>
        </p>
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 0.9rem;">
                    <th style="padding: 1rem 0;">Order ID</th>
                    <th style="padding: 1rem 0;">Date</th>
                    <th style="padding: 1rem 0;">Customer</th>
                    <th style="padding: 1rem 0;">Items</th>
                    <th style="padding: 1rem 0;">Payment</th>
                    <th style="padding: 1rem 0;">Status</th>
                    <th style="padding: 1rem 0; text-align: right;">Total</th>
                    <th style="padding: 1rem 0;">Points</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr style="border-bottom: 1px solid var(--border); {% if order.order_status == 'cancelled' %}opacity: 0.6;{% endif %}">
                    <td style="padding: 1rem 0; font-weight: 600;">#{{ order.id }}</td>
                    <td style="padding: 1rem 0; font-size: 0.95rem;">{{ order.created_at.strftime('%b %d, %Y %H:%M') }}</td>
                    <td style="padding: 1rem 0;">
                        <div>
                            <strong>{{ order.user.username if order.user else 'N/A' }}</strong>
                            <br>
                            <span style="font-size: 0.85rem; color: var(--text-muted);">{{ order.city }}</span>
                        </div>
                    </td>
                    <td style="padding: 1rem 0;">
                        <div style="font-size: 0.9rem;">
                            {{ order.items|length }} item(s)
                            <br>
                            <span style="color: var(--text-muted); font-size: 0.85rem;">
                                {{ order.delivery_option|capitalize }}
                            </span>
                        </div>
                    </td>
                    <td style="padding: 1rem 0;">
                        <span style="padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.85rem; font-weight: 500;
                            {% if order.payment_status == 'completed' %}background: #d1fae5; color: #065f46;
                            {% elif order.payment_status == 'pending' %}background: #fef3c7; color: #92400e;
                            {% else %}background: #fee2e2; color: #991b1b;{% endif %}">
                            {{ order.payment_method|upper }}
                        </span>
                    </td>
                    <td style="padding: 1rem 0;">
                        <span style="padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.85rem; font-weight: 500;
                            {% if order.order_status == 'delivered' %}background: #d1fae5; color: #065f46;
                            {% elif order.order_status == 'shipped' %}background: #dbeafe; color: #1e40af;
                            {% elif order.order_status == 'processing' %}background: #fef3c7; color: #92400e;
                            {% elif order.order_status == 'cancelled' %}background: #fee2e2; color: #991b1b;
                            {% else %}background: #e5e7eb; color: #374151;{% endif %}">
                            {{ order.order_status|capitalize }}
                        </span>
                    </td>
                    <td style="padding: 1rem 0; text-align: right;">
                        <div>
                            <strong style="font-size: 1.1rem; color: var(--primary);">Rs. {{ "%.2f"|format(order.total) }}</strong>
                            {% if order.discount > 0 %}
                            <br>
                            <span style="font-size: 0.85rem; color: #10b981;">-Rs. {{ "%.2f"|format(order.discount) }} discount</span>
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 1rem 0;">
                        <div style="font-size: 0.9rem;">
                            {% if order.points_earned > 0 %}
                                <span style="color: #10b981; font-weight: 600;">+{{ order.points_earned }}</span>
                            {% endif %}
                            {% if order.points_redeemed > 0 %}
                                <br><span style="color: #ef4444; font-weight: 600;">-{{ order.points_redeemed }}</span>
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 1rem 0; vertical-align: top;">
                        <form method="POST" action="{{ url_for('admin_update_order', order_id=order.id) }}" style="display:flex;gap:0.5rem;flex-direction:column;">
                            <select name="order_status" style="padding:0.35rem;border-radius:6px;font-size:0.9rem;">
                                {% for s in ['pending','processing','shipped','delivered','cancelled'] %}
                                <option value="{{ s }}" {% if order.order_status == s %}selected{% endif %}>{{ s|capitalize }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="tracking_number" placeholder="Tracking #" value="{{ order.tracking_number or '' }}" style="padding:0.35rem;border-radius:6px;font-size:0.9rem;">
                            <input type="text" name="carrier" placeholder="Carrier" value="{{ order.carrier or '' }}" style="padding:0.35rem;border-radius:6px;font-size:0.9rem;">
                            <input type="text" name="dispatcher_notes" placeholder="Notes (optional)" value="{{ order.dispatcher_notes or '' }}" style="padding:0.35rem;border-radius:6px;font-size:0.9rem;">
                            <button type="submit" style="margin-top:0.5rem;padding:0.45rem;border-radius:8px;background:#4f46e5;color:#fff;font-weight:600;">Update</button>
                        </form>
                        {% if order.tracking_number %}
                        <div style="margin-top:0.5rem;font-size:0.85rem;color:var(--text-muted);">Tracking: {{ order.tracking_number }} ({{ order.carrier or 'N/A' }})</div>
                        {% endif %}
                        {% if order.delivery_confirmed %}
                        <div style="margin-top:0.25rem;color:#10b981;font-weight:600;font-size:0.85rem;">Delivery Confirmed</div>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-muted);">No orders found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Order Statistics -->
<div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
    
    <div class="card" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border: none;">
        <h4 style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Total Orders</h4>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0;">{{ orders|length }}</p>
    </div>

    <div class="card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none;">
        <h4 style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Delivered</h4>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0;">{{ orders|selectattr('order_status', 'equalto', 'delivered')|list|length }}</p>
    </div>

    <div class="card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none;">
        <h4 style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Pending</h4>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0;">{{ orders|selectattr('order_status', 'equalto', 'pending')|list|length }}</p>
    </div>

    <div class="card" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none;">
        <h4 style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Total Revenue</h4>
        <p style="font-size: 2rem; font-weight: bold; margin: 0;">Rs. {{ "%.0f"|format(orders|selectattr('payment_status', 'equalto', 'completed')|sum(attribute='total')) }}</p>
    </div>

</div>

{% endblock %}
